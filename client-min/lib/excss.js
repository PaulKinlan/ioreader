// Copyright 2011 Google Inc. All Rights Reserved.
//
// Use of this source code is governed by a BSD-type license.
// See the COPYING file for details.
/**
 * Experimental CSS (ExCSS).
 *
 * Supports mixins with arguments, nested selectors, and variables with a
 * dynamic js API.
 *
 * Include as either
 *
 *   <style type="text/excss">
 *     ...
 *   </style>
 *
 * or
 *
 *   <link href="style.excss" type="text/excss"> (requires XHR)
 *
 * Followed by inclusion of this script.
 *
 * Use the js variables API with
 *
 *   CSS.setVariable('myVariable', '#f00');
 *
 * Author: Benjamin Kalman <kalman@chromium.org>
 */// TODO: gracefully deal with errors rather than printing nothing.
// TODO: pretty-print parts not related to rulesets (block? etc).
// TODO: Expression FIXME as described in the code somewhere.
(function(a){function R(){var a=b.querySelectorAll('[type="text/excss"]');Array.prototype.slice.call(a).forEach(function(a,b){var c=a.tagName.toLowerCase();n("Parsing <"+c+"> "+b,function(){var b;if(c==="style")b=L.createFromStyleElement(a);else if(c==="link")b=L.createFromLinkElement(a);else{l('type="text/excss" set on invalid node type "'+c+'"');return}Q.push(b),P.importFromStylesheet(b),O.importFromStylesheet(b)})}),Q.forEach(function(a,b){n("Injecting stylesheet "+b,function(){a.injectCss()})})}function N(a,b){var c=O.get(a);!c||(c.bind(b,O),Q.forEach(function(a){a.injectCss()}))}function M(a){var b=O.get(a);if(!b)return undefined;var c=b.getValue();return c.isVariable?b.getName():c}function L(a,b){this.parseObject=a,this.styleElement=b}function K(a){if(a&&!a.variables)throw new Error("Parent must be an instance of Variables");this.parent=a,this.variables={}}function J(a,b,c){this.ident=a,this.bind(b,c),this.isVariable=!0}function I(){this.traits={}}function H(a){function i(){return g[g.length-1]}var b=G(a);if(b.parseObject)return b.parseObject;var c=x.Grammar.stylesheet(F(a));if(!c)m("Unable to parse stylesheet: "+a);else{e&&c.run();var d={traits:{},rulesets:[],variables:{}},f,g=[],h;c.run({selector:function(a){a=a.replace(/ *$/,""),g.length===0?(g.push({selector:a,rules:[]}),d.rulesets.push(i())):i().selector+=a},declaration:function(a){f={declaration:a},i().rules.push(f)},mixin_ident:function(a){f={mixin:{ident:a,args:[]}},i().rules.push(f)},mixin_arg:function(a){f.mixin.args.push(a)},trait_ident:function(a){g.length>0?m("Traits can only be declared at the top level (for now...)"):(g.push({params:[],rules:[]}),d.traits[a]=i())},trait_param:function(a){i().params.push(a)},var_ident:function(a){h=a},var_init:function(a){d.variables[h]=a},nested_decl:function(a){f={nested:{selector:a,rules:[]}},i().rules.push(f),g.push(f.nested)},rulebody:function(a){g.pop()}});return d}}function G(a){var b="/*{{{",c=a.indexOf(b);if(c===-1)return{markup:a};var d=a.slice(0,c),e=a.slice(c+b.length),f="}}}*/",g=e.indexOf(f);if(g===-1){l("Malformed parse object in stylesheet: "+a);return{markup:a}}var h=JSON.parse(e.slice(0,g)),i=e.slice(g+f.length);return{markup:d+i,parseObject:h}}function F(a){return a.replace(/\/\*.*\*\//g,"")}function E(a){Object.keys(a).forEach(function(b){a[b]=w(b,a[b])});return a}function D(a){Object.keys(a).forEach(function(b){a[b]=p(a[b])});return a}function C(a){return y("Grammar",a)}function A(a){var b=a.indexOf("EXCSS_")===0?"ExCssTokens":"Tokens";return y(b,a)}function z(a){return y("Macros",a)}function y(a,b){return function(c){var d=x[a];if(!d)throw new Error("Can't find table "+a);var e=d[b]?d[b]:d[b+"_"];if(!e)throw new Error("Can't find token for key "+b+" in "+a);return e(c)}}function w(a,b){return function(c){var d=b(c);if(!d)return undefined;d.type=a;return d}}function v(){return t(u.apply(undefined,arguments))}function u(){var a=arguments;return function(b){var c=[],d=b,e;for(;;){var f=q.apply(undefined,a)(d);if(!f)return e;c.push(f),d=f.remainder,e=new o(c,d,f.type)}}}function t(){var a=arguments;return function(b){var c=q.apply(undefined,a)(b);return c?c:new o("",b)}}function s(){return function(a){return undefined}}function r(){var a=arguments;return function(b){for(var c=0;c<a.length;c++){var d=p(a[c])(b);if(d)return new o(d,d.remainder)}return undefined}}function q(){var a=arguments;return function(b){var c=[],d=b;for(var e=0;e<a.length;e++){var f=p(a[e])(d);if(!f)return undefined;c.push(f),d=f.remainder}return new o(c,d)}}function p(a){if(typeof a=="string")return function(b){return b.indexOf(a.toLowerCase())===0?new o(a,b.slice(a.length)):undefined};if(a instanceof RegExp)return function(b){var c=a.toString().match(/^\/([^\/]*)\/[^\/]*$/)[1],d=b.match(new RegExp("^("+c+")","i"));if(!d)return undefined;var e=d[0];return new o(e,b.slice(e.length))};if(a instanceof Array)return q.apply(undefined,a);if(a instanceof Function)return a;throw new Error("Unknown argument to rule: "+a)}function o(a,b,c){this.value=a,this.remainder=b,this.type=c}function n(a,b){var c,d,e;f&&(c=(new Date).getTime()),d=b(),f&&(e=(new Date).getTime()-c,i("INSTRUMENTATION: "+a+" took "+e+"ms"));return d}function m(a){d?(m=function(a){d.error("EXCSS ERROR: "+a)},m(a)):m=j}function l(a){d?(l=function(a){d.warn("EXCSS WARNING: "+a)},l(a)):l=j}function k(a){k=e?i:j}function j(a){}function i(a){d&&(i=function(a){d.log("EXCSS: "+a)},i(a))}"use strict";var b=a.document,c=a.exports,d=a.console,e=!1,f=!1;if(b){var g=b.getElementsByTagName("script"),h=g[g.length-1];h.getAttribute("debug")==="true"&&(e=!0),h.getAttribute("instrumented")==="true"&&(f=!0)}Object.keys=Object.keys||function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(b);return c};var x={},B=A("SS");x.Macros=D({ident:[t("-"),z("nmstart"),v(z("nmchar"))],name:u(z("nmchar")),nmstart:r(/[_a-z]/,z("nonascii"),z("escape")),nonascii:s(),unicode:[/\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?/],escape_:r(z("unicode"),["\\",/"[^\n\r\f0-9a-f]"/]),nmchar:r(/[_a-z0-9\-]/,z("nonascii"),z("escape")),num:[/[0-9]*\.[0-9]+|[0-9]+/],string:r(z("string1"),z("string2")),string1:['"',v(r(/[^\n\r\f"]/,["\\",z("nl")],z("escape"))),'"'],string2:["'",v(r(/[^\n\r\f']/,["\\",z("nl")],z("escape"))),"'"],invalid:r(z("invalid1"),z("invalid2")),invalid1:['"',v(r(/[^\n\r\f\"]/,["\\",z("nl")],z("escape")))],invalid2:["'",v(r(/[^\n\r\f\"]/,["\\",z("nl")],z("escape")))],nl:/\n|\r\n|\r|\f/,w:/[ \t\r\n\f]*/}),x.Tokens=D({IDENT:z("ident"),ATKEYWORD:["@",z("ident")],STRING:z("string"),INVALID:z("invalid"),HASH:["#",z("name")],NUMBER:z("num"),PERCENTAGE:[z("num"),"%"],DIMENSION:[z("num"),z("ident")],URI:r(["url(",z("w"),z("string"),z("w"),")"],["url(",z("w"),v(r(/[!#$%&*-~]/,z("nonascii"),z("escape"))),z("w"),")"]),UNICODE_RANGE:s(),CDO:"<!--",CDC:"-->",S:/[ \t\r\n\f]+/,SS:/[ \t\r\n\f]*/,FUNCTION_:[z("ident"),"("],INCLUDES:"~=",DASHMATCH:"|=",DELIM:/[^@#% :;{}()\[\]\t\r\n\f'"]/,NOTBRACE:/[^{}]/}),x.ExCssTokens=D({EXCSS_VARIABLE_IDENT:["$",z("ident")]}),x.Grammar=E(D({stylesheet:v(r(A("S"),C("statement"))),statement:r(C("var_decl"),C("trait"),C("ruleset")),var_decl:["@var",B,C("var_ident"),B,C("var_init"),u(";")],var_ident:A("IDENT"),var_init:C("values"),trait:["@trait",B,C("trait_ident"),B,t(C("trait_params"),B),C("rulebody")],trait_ident:A("IDENT"),trait_params:["(",B,C("trait_param"),v(",",B,C("trait_param")),")"],trait_param:A("IDENT"),rulebody:["{",B,v(C("ruleitem"),B),t(C("ruleitem_single"),B),"}"],ruleitem:[r(C("nested"),[C("mixin"),";"],[C("declaration"),";"]),v(";")],ruleitem_single:r(C("nested"),C("mixin"),C("declaration")),nested:[C("nested_selector"),C("selector"),C("rulebody")],nested_selector:[C("nested_decl"),C("selector")],nested_decl:"&",selector:v(A("NOTBRACE")),mixin:["@mixin",B,u(C("mixin_value"),B)],mixin_value:[C("mixin_ident"),B,t(C("mixin_args"))],mixin_ident:A("IDENT"),mixin_args:["(",B,C("mixin_arg"),v(",",B,C("mixin_arg")),")"],mixin_arg:C("value"),declaration:[C("property"),B,":",B,C("values")],property:A("IDENT"),ruleset:[C("selector"),C("rulebody")],values:u(C("value")),value:[r([A("FUNCTION"),B,v(C("value")),")"],A("IDENT"),A("EXCSS_VARIABLE_IDENT"),A("PERCENTAGE"),A("DIMENSION"),A("NUMBER"),A("STRING"),A("DELIM"),A("URI"),A("HASH"),A("UNICODE_RANGE"),A("INCLUDES"),A("DASHMATCH"),":",A("ATKEYWORD"),["(",B,v(C("value")),")"],["[",B,v(C("value")),"]"]),B]})),o.prototype.run=function(a){a||(a={},Object.keys(x.Grammar).forEach(function(b){a[b]=function(a){k(b+': "'+a+'"')}}));var b="";this.value instanceof Array?this.value.forEach(function(c){b+=c instanceof o?c.run(a):c}):b=this.value instanceof o?this.value.run(a):this.value;if(this.type){var c=a[this.type];c&&c(b)}return b},I.prototype.get=function(a){return this.traits[a]},I.prototype.importFromStylesheet=function(a){var b=this,c=a.getParseObject().traits;Object.keys(c).forEach(function(a){b.traits[a]=c[a]})},J.prototype.getName=function(){return"$"+this.ident},J.prototype.getValue=function(){return this.value},J.prototype.resolve=function(){if(!this.value.isVariable)return this.value;if(this.mark){l('Circular reference while resolving "'+this.ident+'"');return undefined}this.mark=!0;var a=this.value.resolve();delete this.mark;return a},J.prototype.bind=function(a,b){if(b&&a.indexOf&&a.indexOf("$")===0){var c=b.get(a.slice("$".length));c?a=c:l('Attempted to bind "'+this.ident+'" to unknown variable "'+a+'"')}this.value=a},K.prototype.newEnvironment=function(){return new K(this)},K.prototype.importFromStylesheet=function(a){var b=this,c=a.getParseObject().variables;Object.keys(c).forEach(function(a){b.variables[a]=new J(a,c[a])}),Object.keys(this.variables).forEach(function(a){var c=b.variables[a];b.variables[a].bind(c.getValue(),b)})},K.prototype.set=function(a,b){if(!b.isVariable)throw new Error("Variable must be an instance of Variable");this.variables[a]=b},K.prototype.get=function(a){if(this.variables.hasOwnProperty(a))return this.variables[a];return this.parent?this.parent.get(a):undefined},K.prototype.getAllVariables=function(){var a=this,b=this.parent?this.parent.getAllVariables():{};Object.keys(this.variables).forEach(function(c){b[c]=a.variables[c]});return b},K.prototype.substitute=function(a){var b=this.getAllVariables(),c=Object.keys(b).sort(function(a,b){return b.length-a.length});for(var d=0;d<c.length;d++){var e=c[d],f=b[e];while(a.indexOf(f.getName())>=0)a=a.replace(f.getName(),f.resolve())}return this.parent?this.parent.substitute(a):a},L.prototype.getParseObject=function(){return this.parseObject},L.createFromStyleElement=function(a){if(a.type!=="text/excss")throw new Error("Style element isn't ExCSS");var b=H(a.innerHTML);if(!b){l("Failed to parse style element: "+a.innerHTML);return null}return new L(b,a)},L.createFromLinkElement=function(c){if(c.type!=="text/excss")throw new Error("Link element didn't have type text/excss");var d=c.href;if(!d){l("Link element didn't have a valid href");return null}var e=n("  XHR for "+d,function(){var b=new a.XMLHttpRequest;b.open("GET",d,!1),b.send(null);return b.status===200?b.responseText:undefined});if(!e){l("Failed to fetch "+d);return null}var f=n("  Parsing...",function(){return H(e)});if(!f){l("Failed to parse the stylesheet from "+d);return null}var g=n("  DOM bs...",function(){g=b.createElement("style"),g.setAttribute("link_href",c.href),c.parentNode.insertBefore(g,c),c.parentNode.removeChild(c);return g});return new L(f,g)},L.prototype.injectCss=function(){function d(a,e,f){var g=a+" {\n"+b(e,f)+"}\n";c(e).forEach(function(b){var c=b.selector.replace(/&/g,a);g+=d(c,b.rules,f)});return g}function c(a){return a.filter(function(a){return!!a.nested}).map(function(a){return a.nested})}function b(a,c){return a.reduce(function(a,d){if(d.declaration)a+="  "+c.substitute(d.declaration)+";\n";else if(d.mixin){var e=P.get(d.mixin.ident);if(!e)return a;var f=d.mixin.args,g=e.params,h=c.newEnvironment();for(var i=0;i<f.length&&i<g.length;i++)h.set(g[i],new J(g[i],f[i],c));a+=b(e.rules,h)}return a},"")}if(!this.styleElement)throw new Error("Stylesheet hasn't been constructed with a style element");this.styleElement.parentNode||l("CSS will be injected, but style node isn't attached to anything");var a=this,e="";this.parseObject.rulesets.forEach(function(a){e+=d(a.selector,a.rules,O)}),e.trim()===""&&l("CSS injection is empty.  This might be because the original ExCSS markup was empty, or because the original ExCSS markup has syntax errors, or because ExCSS has a bug."),this.styleElement.type="text/css",this.styleElement.innerHTML=e},a.CSS||(a.CSS={parse:H,extractMarkupAndParseObject:G,getVariable:M,setVariable:N,__locals__:{VARIABLES:new K,TRAITS:new I,STYLESHEETS:[]}});var O=a.CSS.__locals__.VARIABLES,P=a.CSS.__locals__.TRAITS,Q=a.CSS.__locals__.STYLESHEETS;b&&n("Running ExCSS",R)})(window)