var BaseController=function(){var a=function(a,b){var c=document.createEvent("Event");c.initEvent(a,!0,!0),c.data=b,window.dispatchEvent(c)},b=function(a){e()},c=function(a){f(a.params.category)},d=function(a){var b=a.params;g(b.category,b.article)},e=function(){$("html").addClass("menuState"),$(".category").removeClass("active"),a("rootchanged",{})},f=function(b){var c=b;$("html").addClass("categoryState"),$(".category").removeClass("active"),$("article").removeClass("active"),$("li[data-category='"+c+"']").addClass("active"),$("section[data-category='"+c+"']").addClass("active"),a("categorychanged",{category:c})},g=function(b,c){$("html").addClass("articleState"),$(".category").removeClass("active"),$("article").removeClass("active"),$("li[data-category='"+b+"']").addClass("active"),$("section[data-category='"+b+"']").addClass("active"),$("article[data-article='"+c+"']").addClass("active"),a("articlechanged",{category:b,article:c})},h=function(b,c,d){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(e.readyState==4&&e.status==200){var b=JSON.parse(e.responseText);d(b),a("articleready",b)}},e.open("GET","/reader/"+b+"/"+c+".json"),e.send()},i=function(b,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState==4&&d.status==200){var b=JSON.parse(d.responseText);c(b),a("categoryready",b)}},d.open("GET","/reader/"+b+".json"),d.send()},j=function(b){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(c.readyState==4&&c.status==200){var d=JSON.parse(c.responseText);b(d),a("allready",d)}},c.open("GET","/index.json"),c.send()},k,l=function(){return $("section.category.active")},m=function(){return $("article.active")},n=function(a){k=$(a);var b=k.data();b.article?(window.history.pushState&&window.history.pushState(undefined,"","/reader/"+b.category+"/"+b.article),g(b.category,b.article),console.log("loading article"),$("html").addClass("loadingArticle"),h(b.category,b.article,function(b){var c=b.categories,d;for(var e=0;d=c[e];e++){var f=d.articles,g;if(f.length>0)for(var h=0;g=f[h];h++)if(g.articleState=="active"){$(".story",a).html(g.body);return}}setTimeout(function(){$("html").removeClass("loadingArticle"),console.log("article loaded")},2e3)})):b.category?(window.history.pushState&&window.history.pushState(undefined,"","/reader/"+b.category),f(b.category)):(window.history.pushState&&window.history.pushState(undefined,"","/reader/"+b.category+"/"+b.article),e())},o={article:'{{#articles}} <article id="{{id}}" data-article="{{id}}" data-category="{{categoryId}}"> <header> <h1><a href="/reader/{{id}}">{{title}}</a></h1> <p><time pubdate time="{{puddate}}"></time></p> <img class="thumbnail" src="{{thumbnail}}" src-hi="{{largeImage}}" /> <div class="summary">{{{shortDescription}}}</div> </header> <section> <h1>{{title}}</h1> <p><time pubdate time="{{puddate}}"></time></p> <div class="summary">{{{shortDescription}}}</div><img class="large" src="{{largeImage}}" src-lo="{{thumbnail}}" /> <div class="story"></div> </section> <footer> <a href="{{url}}">Link</a> </footer> </article> {{/articles}}',category:'{{#categories}}<section class="category {{cateogoryState}}" data-category="{{id}}" id="{{id}}"><h2>{{name}}</h2><div class="articles">{{> article }}</div></section>{{/categories}}'},p=function(){$("html").addClass("refreshing"),console.log("refreshing"),j(function(a){var b=a.categories,c;for(var d=0;c=b[d];d++){console.log("Looking for category "+c.id);var e=c.articles,f,g=$("#"+c.id);for(var h=0;f=e[h];h++){var i=$("[data-article='"+f.id+"']",g);i.length==0&&g.prepend(Mustache.to_html(o.article,f))}}setTimeout(function(){$("html").removeClass("refreshing"),console.log("refreshed")},2e3)})},q=new routes;q.get("^/",b),q.get("^/reader/:category",c),q.get("^/reader/:category.html",c),q.get("^/reader/:category/:article",d);return{onRootChanged:b,onCategoryChanged:c,onArticleChanged:d,activate:n,refresh:p,getActiveArticle:m,getActiveCategory:l}}